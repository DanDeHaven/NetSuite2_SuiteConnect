create or replace view FINANCE.ADMIN_CORE_CURATED.CTS_NS_TRANSACTION(
	NS_TRANSACTION_ID,
	NS_CREATED_BY_ID,
	NS_ACCOUNTING_PERIOD_ID,
	NS_ENTITY_ID,
	NS_EMPLOYEE_ID,
	RECORDTYPE,
	TYPE,
	TRAN_DISPLAY_NAME,
	TRAN_ID,
	TRANSACTIONNUMBER,
	TRANSACION_NUMBER,
	EXCHANGE_TYPE,
	EXCHANGE_RETURN_REASON,
	NS_PARTNER_ID,
	STATUS,
	PERIOD_ENDING_DATE,
	HUBSPOT_DEAL_ID,
	NEXUS,
	TERMS,
	PAYMENT_METHOD,
	PAYMENT_OPTION,
	CURRENCY,
	EXCHANGE_RATE,
	MEMO,
	IS_POSTING,
	VOIDED,
	TRANSACTION_DATE,
	DUE_DATE
) as

SELECT
    SD.ID AS NS_TRANSACTION_ID,
    SD.CREATEDBY AS NS_CREATED_BY_ID,
    SD.POSTINGPERIOD AS NS_ACCOUNTING_PERIOD_ID,
    SD.ENTITY AS NS_ENTITY_ID,
    SD.EMPLOYEE AS NS_EMPLOYEE_ID,
    SD.RECORDTYPE,
    SD.TYPE,
    SD.TRANDISPLAYNAME AS TRAN_DISPLAY_NAME,
    SD.TRANID AS TRAN_ID,
    SD.TRANSACTIONNUMBER,
    SD.NUMBER AS TRANSACION_NUMBER,
    ET.LIST_NAME AS EXCHANGE_TYPE,
    ER.LIST_NAME AS EXCHANGE_RETURN_REASON,
    SD.PARTNER AS NS_PARTNER_ID,
    SD.STATUS,
    AP.ENDDATE::DATE AS PERIOD_ENDING_DATE,
    CASE 
        WHEN SPLIT_PART(SD.CUSTBODYHUBSPOTDEALURL, '/', -1) < '1' THEN SPLIT_PART(SD.CUSTBODYHUBSPOTDEALURL, '/', -2)
        else SPLIT_PART(SD.CUSTBODYHUBSPOTDEALURL, '/', -1) 
    END AS HUBSPOT_DEAL_ID,
    NX.STATE AS NEXUS,
    TER.NAME AS TERMS,
    PM.NAME AS PAYMENT_METHOD,
    PIT.NAME AS PAYMENT_OPTION,
    CUR.NAME AS CURRENCY,
    SD.EXCHANGERATE AS EXCHANGE_RATE,
    SD.MEMO,
    CASE SD.POSTING WHEN 'T' THEN 'Yes' ELSE 'No' END AS IS_POSTING,
    CASE SD.VOIDED WHEN 'T' THEN 'Yes' ELSE 'No' END AS VOIDED,
    SD.TRANDATE::DATE AS TRANSACTION_DATE,    
    SD.DUEDATE::DATE AS DUE_DATE
    
FROM
    FINANCE.CTS_NETSUITE2.TRANSACTION SD
        LEFT OUTER JOIN
    FINANCE.CTS_NETSUITE2.ACCOUNTINGPERIOD AP
            ON SD.POSTINGPERIOD = AP.ID
         LEFT OUTER JOIN
    FINANCE.CTS_NETSUITE2.PAYMENTMETHOD PM
            ON SD.PAYMENTMETHOD = PM.ID
        LEFT OUTER JOIN
    FINANCE.CTS_NETSUITE2.TERM TER
            ON SD.TERMS = TER.ID
        LEFT OUTER JOIN
    FINANCE.CTS_NETSUITE2.CURRENCY CUR
            ON SD.CURRENCY = CUR.ID
        LEFT OUTER JOIN
    FINANCE.CTS_NETSUITE2.NEXUS NX
            ON SD.NEXUS = NX.ID
        LEFT OUTER JOIN
    FINANCE.CTS_NETSUITE2.PAYMENTINSTRUMENTTYPE PIT
            ON SD.PAYMENTOPTION = PIT.KEY
        LEFT OUTER JOIN 
    FINANCE.CTS_NETSUITE2.EXCHANGEREASON_LIST ER 
            ON SD.CUSTBODY_RETURN_REASON_V2 = ER.LIST_ID 
        LEFT OUTER JOIN 
    FINANCE.CTS_NETSUITE2.EXCHANGETYPE_LIST ET 
            ON SD.CUSTBODY_EXCHANGE_TYPE = ET.LIST_ID 

WHERE
    SD._FIVETRAN_DELETED = 'FALSE';
